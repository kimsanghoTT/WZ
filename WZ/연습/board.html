<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>게시판</title>
<style>
    /* 기존 스타일 유지 */
    body { font-family: Arial, sans-serif; margin: 20px; background:#f4f4f4; color:#333; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
    h1 { text-align:center; color:#555; }
    .post-list { list-style:none; padding:0; border-top: 2px solid #333;}
    .post-list li { padding: 15px 0; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; align-items:center;}
    .post-list li:last-child { border-bottom:none; }
    .post-title a { text-decoration:none; color:#337ab7; font-weight:bold; }
    .post-title a:hover { text-decoration:underline; }
    .post-meta { font-size:0.9em; color:#888; }
    .post-meta span { margin-left:10px; }
    .write-btn { display:block; width:150px; padding:10px; margin:20px auto 0; text-align:center; text-decoration:none; background:#5cb85c; color:#fff; border-radius:5px; font-weight:bold; }
    .write-btn:hover { background:#4cae4c; }
</style>
</head>
<body>

<div class="container">
    <h1>게시판</h1>

    <ul class="post-list" id="postList">
        <!-- JS로 게시글 리스트 생성 -->
    </ul>

    <a href="write.html" class="write-btn">글쓰기</a>
</div>

<script>
    const DB_NAME = 'boardDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'posts';
    let db;

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = () => reject('DB 열기 실패');
            request.onsuccess = (e) => {
                db = e.target.result;
                resolve(db);
            };

            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    store.createIndex('createdAt', 'createdAt', { unique: false });
                }
            };
        });
    }

    function getAllPosts() {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                resolve(request.result);
            };
            request.onerror = () => reject('게시글 조회 실패');
        });
    }

    function formatDate(dateStr) {
        const d = new Date(dateStr);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}.${mm}.${dd}`;
    }

    function renderPosts(posts) {
        const ul = document.getElementById('postList');
        ul.innerHTML = '';

        // 최신 글이 위로 오도록 내림차순 정렬
        posts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

        if(posts.length === 0){
            ul.innerHTML = '<li>등록된 게시글이 없습니다.</li>';
            return;
        }

        posts.forEach(post => {
            const li = document.createElement('li');

            const titleDiv = document.createElement('div');
            titleDiv.className = 'post-title';

            const a = document.createElement('a');
            a.href = `detail.html?id=${post.id}`;
            a.textContent = post.title;

            titleDiv.appendChild(a);

            const metaDiv = document.createElement('div');
            metaDiv.className = 'post-meta';

            const authorSpan = document.createElement('span');
            authorSpan.className = 'author';
            authorSpan.textContent = post.author;

            const dateSpan = document.createElement('span');
            dateSpan.className = 'date';
            dateSpan.textContent = formatDate(post.createdAt);

            metaDiv.appendChild(authorSpan);
            metaDiv.appendChild(dateSpan);

            li.appendChild(titleDiv);
            li.appendChild(metaDiv);

            ul.appendChild(li);
        });
    }

    openDB()
    .then(() => getAllPosts())
    .then(posts => renderPosts(posts))
    .catch(console.error);
</script>

</body>
</html>
